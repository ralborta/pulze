generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  phone             String    @unique
  name              String
  email             String?
  goal              String    // "Bajar peso", "Ganar músculo", etc.
  restrictions      String?   // Lesiones, alergias, etc.
  activityLevel     String?   // "Sedentario", "Activo", "Muy activo"
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  lastCheckInDate   DateTime?
  onboardingComplete Boolean  @default(false)
  isActive          Boolean   @default(true)
  isPremium         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  checkIns          CheckIn[]
  preferences       UserPreferences?
  conversations     Conversation[]
  stats             UserStats?
  
  @@index([phone])
  @@index([isActive])
  @@index([lastCheckInDate])
}

model CheckIn {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sleep         Int      // 1-5 rating
  energy        Int      // 1-5 rating
  mood          String   // Texto libre o rating
  willTrain     Boolean
  trainedToday  Boolean  @default(false)
  notes         String?  // Notas adicionales del usuario
  
  aiResponse    String?  @db.Text // Respuesta generada por IA
  recommendation String? @db.Text // Recomendación del día
  
  timestamp     DateTime @default(now())
  
  @@index([userId])
  @@index([timestamp])
}

model UserPreferences {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reminderTime      String   @default("08:00")
  reminderDays      String[] @default(["1", "2", "3", "4", "5", "6", "0"])
  language          String   @default("es")
  timezone          String   @default("America/Argentina/Buenos_Aires")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Content {
  id          String   @id @default(uuid())
  category    String   // "Entrenamiento", "Nutrición", "Mentalidad", "Bienestar"
  type        String   // "tip", "guia", "rutina", "articulo"
  title       String
  description String
  content     String   @db.Text
  tags        String[]
  difficulty  String?  // "Principiante", "Intermedio", "Avanzado"
  duration    String?  // "5 min", "15 min", etc.
  viewCount   Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([type])
  @@index([isActive])
}

model MessageTemplate {
  id          String   @id @default(uuid())
  key         String   @unique   // "welcome", "checkin_morning", "weekly_summary", etc.
  type        String               // "onboarding", "checkin", "resumen", "reactivacion", "felicitacion"
  name        String
  content     String   @db.Text
  variables   String[]             // ["nombre", "racha", "objetivo"]
  usageCount  Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
  @@index([type])
}

model Analytics {
  id          String   @id @default(uuid())
  eventType   String   // "onboarding_started", "onboarding_completed", "checkin_completed", etc.
  userId      String?
  metadata    Json?
  
  timestamp   DateTime @default(now())
  
  @@index([eventType])
  @@index([userId])
  @@index([timestamp])
}

model Conversation {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String   // "user" | "assistant"
  message     String   @db.Text
  metadata    Json?    // Cualquier dato adicional (tipo de mensaje, contexto, etc.)
  
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([timestamp])
}

model UserStats {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalCheckIns         Int      @default(0)
  currentStreak         Int      @default(0)
  longestStreak         Int      @default(0)
  averageSleep          Float?
  averageEnergy         Float?
  trainingDays          Int      @default(0)
  lastActiveDate        DateTime?
  
  // Engagement metrics
  messagesReceived      Int      @default(0)
  messagesSent          Int      @default(0)
  contentsViewed        Int      @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
